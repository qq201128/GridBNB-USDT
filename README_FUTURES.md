# 币安合约网格交易系统

这是一个基于原现货网格交易系统改造的合约版本，支持币安永续合约交易。

## 主要变化

### 1. 交易模式
- **现货** → **合约**：从现货交易改为永续合约交易
- **杠杆支持**：支持1-125倍杠杆（默认10倍）
- **保证金模式**：支持逐仓和全仓模式（默认逐仓）

### 2. 仓位管理
- **余额计算**：从现货+理财余额改为合约账户USDT余额
- **仓位计算**：基于合约名义价值和杠杆倍数
- **风险控制**：适配合约交易的风险特征

### 3. 订单执行
- **订单类型**：支持合约特有的订单参数
- **仓位调整**：支持做多/做空仓位调整
- **风险管理**：考虑杠杆风险的仓位限制

## 配置说明

### 基本配置 (config_futures.py)
```python
FUTURES_SYMBOLS = {
    'BTC/USDT': {
        'leverage': 10,           # 杠杆倍数
        'margin_mode': 'isolated', # 保证金模式
        'initial_grid': 2.0       # 初始网格大小
    }
}
```

### 风险参数
- `MAX_POSITION_RATIO`: 0.8 (最大仓位比例80%)
- `MIN_POSITION_RATIO`: 0.1 (最小仓位比例10%)
- `DEFAULT_LEVERAGE`: 10 (默认杠杆10倍)

## 启动方式

### 1. 安装依赖
```bash
pip install -r requirements.txt
```

### 2. 配置API密钥和网络
确保在环境变量中设置了币安API密钥和代理：
```bash
export BINANCE_API_KEY="your_api_key"
export BINANCE_API_SECRET="your_api_secret"
export HTTP_PROXY="http://127.0.0.1:10809"
export HTTPS_PROXY="http://127.0.0.1:10809"
```

或者创建 `.env` 文件：
```bash
cp .env.example .env
# 然后编辑 .env 文件填入你的API密钥
```

### 3. 测试网络连接
```bash
# 测试网络连接
python test_connection.py

# 简化测试
python simple_test.py

# 完整测试
python test_futures.py
```

### 4. 启动合约交易
```bash
python main_futures.py
```

## 重要提醒

### ⚠️ 风险警告
1. **合约交易风险极高**：可能导致全部资金损失
2. **杠杆放大风险**：盈亏都会被杠杆倍数放大
3. **强制平仓风险**：保证金不足时会被强制平仓
4. **测试建议**：建议先在测试网或小资金测试

### 🔧 使用建议
1. **从低杠杆开始**：建议从2-5倍杠杆开始
2. **设置止损**：合理设置仓位限制
3. **监控保证金**：确保账户有足够保证金
4. **分散风险**：不要将所有资金投入单一交易对

## 主要文件说明

- `main_futures.py`: 合约交易启动脚本
- `config_futures.py`: 合约交易配置
- `position_controller_futures.py`: 合约仓位控制器
- `exchange_client.py`: 交易所客户端（已修改为合约模式）
- `trader.py`: 主交易器（已适配合约）
- `risk_manager.py`: 风险管理器（已适配合约）

## 监控和日志

系统会生成详细的交易日志：
- 文件名格式：`futures_trading_YYYYMMDD.log`
- 包含仓位变化、订单执行、风险控制等信息

## 故障排除

### 常见问题
1. **网络连接失败**：
   - 检查代理设置：`HTTP_PROXY=http://127.0.0.1:10809`
   - 运行网络测试：`python test_connection.py`
   - 确保代理服务正常运行

2. **API权限不足**：
   - 确保API密钥有合约交易权限
   - 检查API密钥是否正确设置

3. **保证金不足**：
   - 检查合约账户USDT余额
   - 确保有足够保证金支持杠杆交易

4. **杠杆设置失败**：
   - 某些交易对可能有杠杆限制
   - 检查币安合约交易规则

### 紧急停止
程序支持优雅关闭：
- `Ctrl+C`: 发送中断信号
- 系统会自动取消未成交订单并安全退出

## 技术支持

如遇问题，请检查：
1. 日志文件中的错误信息
2. API密钥权限设置
3. 网络连接状态
4. 账户余额和仓位状态

---

**免责声明**: 本软件仅供学习和研究使用，使用者需自行承担交易风险。作者不对任何交易损失负责。